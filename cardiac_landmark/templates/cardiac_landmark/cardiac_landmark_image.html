{% extends 'annotationweb/two_column_layout.html' %}

{% block javascript %}

    initializeAnnotation({{ task.id }}, {{ image.id }});

    loadSequence(
        {{ image_sequence.id }},
        {{ image_sequence.start_frame_nr }},
        {{ image_sequence.nr_of_frames }},
        {{ frame_nr }},
        {%  if task.show_entire_sequence %}true{% else %}false{% endif %},
        {{ task.frames_before }},
        {{ task.frames_after }},
        {% if task.auto_play %}true{% else %}false{% endif %}
    );
    loadLandmarkTask({{ image_sequence.id }}, {{ frame_nr }});

    addLabelButton(0, 0, 255, 0, 0);
    addLabelButton(1, 0, 0, 255, 0);
    addLabelButton(2, 255, 0, 0, 0);

    {% if return_url %}
        setReturnURL('{{ return_url|safe }}');
    {% endif %}

    {% if landmark %}
        {% if landmark.frame_ED >= 0 %}
            markED({{ landmark.frame_ED }}, {{ image_sequence.nr_of_frames }});
        {% endif %}
        {% if landmark.frame_ES >= 0 %}
            markES({{ landmark.frame_ES }}, {{ image_sequence.nr_of_frames }});
        {% endif %}

        {% for control_point in control_points %}
            addControlPoint({{ control_point.x }}, {{ control_point.y }}, {{ control_point.object }}, {{ control_point.phase }}, {% if control_point.uncertain %}true{% else %}false{% endif %});
        {% endfor %}

    {% endif %}

{% endblock javascript %}

{% block content_left %}

    {% for message in messages %}
        <div{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</div>
    {% endfor %}
    <div id="message"></div>

    <h1>{{ task.name }}</h1>

    {{ number_of_labeled_images }} of {{ total_number_of_images}} images has been labeled ({{ percentage_finished }}%).<br />

    {% if image_sequence %}
        <div id="progressbar"><div class="progress-label">Loading...</div></div>
        <!-- <canvas id="m-mode-canvas">Failed to show images. Canvas probably not supported in the browser.</canvas> -->
        <div id="slider">
            <div id="sliderEDmark"></div>
            <div id="sliderESmark"></div>
        </div>
        <!--<p>
            Current frame: <span id="currentFrame"></span>
            ED frame: <span id="EDFrame">Not selected</span>
            ES frame: <span id="ESFrame">Not selected</span>
        </p>-->
        <div class="actionButtons">
            <div class="flexButtons">
                <button id="markAsED" style="background-color: #CC3434">Mark as End Diastole</button>
                <button id="markAsES" style="background-color: #0077b3">Mark as End Systole</button>
            </div>
            <div class="flexButtons">
                <button id="segmentED" style="background-color: #CC3434">Go to End Diastole</button>
                <button id="segmentES" style="background-color: #0077b3">Go to End Systole</button>
            </div>
        </div>
    {% endif %}
    <h2>Actions</h2>
    <div class="actionButtons">
        <button id="playButton" type="button">Play</button>
        {% if previous_image_id %}
            <button onclick="javascript:changeImage('{% url 'annotate' task.id previous_image_id %}?{{ request.GET.urlencode }}');">Previous</button>
        {% endif %}
        {% if next_image_id %}
            <button onclick="javascript:changeImage('{% url 'annotate' task.id next_image_id %}?{{ request.GET.urlencode }}');">Next</button>
        {% endif %}
        <button id="clearButton">Clear</button>
        <button id="rejectButton" alt="By rejecting this image, it is removed from the dataset. You may write a comment below of why it was rejected.">Save as rejected</button>
        <button id="saveButton">Save</button>
        <button onclick="javascript:window.location.href='{% url 'task' task.id %}'">Image list</button>
    </div>
    <div id="dialogConfirm">
        You have done changes to the annotation. <br>
        Do you wish to save the changes before going to the next/previous image?
    </div>
    <h2>Annotation</h2>
    <div id="imageQuality">
        <form id="imageQualityForm">
            Image quality:
            {% for quality_id, quality_name in image_quality_choices %}
                <input type="radio" name="quality" value="{{ quality_id }}" required{% if chosen_quality == quality_id %} checked="checked"{% endif %}> {{ quality_name }}
            {% endfor %}
        </form>
    </div>

    <div id="labelButtons">
        <div class="flexButtons">
            <button onclick="changeLabel(0)" class="labelButton" id="labelButton0">Anterior</button>
            <button onclick="changeLabel(1)" class="labelButton" id="labelButton1">Apex</button>
            <button onclick="changeLabel(2)" class="labelButton" id="labelButton2">Inferior</button>
        </div>
    </div>

    <div>
    <h2>Comments</h2>
    <textarea id="comments" style="width: 100%; height: 100px">{{ comments }}</textarea>
    </div>

{% endblock content_left %}
{% block content_right %}

    <canvas id="canvas">Failed to show images. Canvas probably not supported in the browser.</canvas>


    {% block task_content %}
    {% endblock %}

    {% if image.metadata_set.count > 0 %}
        <h2>Image metadata</h2>
        {% for metadata in image.metadata_set.all %}
            <strong>{{ metadata.name }}:</strong> {{ metadata.value }}<br>
        {% endfor %}
    {% endif %}

    {% if task.description|length > 0 %}
        <h2>Task description</h2>

        {{ task.description|safe }}
    {% endif %}

{% endblock content_right %}